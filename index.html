<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phoenix Voice Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f0f0f0;
      position: relative;
    }
    #output {
      font-size: 1.5em;
      color: #333;
      text-align: center;
      padding: 20px;
    }
    #animation {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #3498db;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.2); }
      100% { transform: translateX(-50%) scale(1); }
    }
  </style>
</head>
<body>
  <div id="output">Say "Hello Phoenix" to begin...</div>
  <div id="animation"></div>

  <script>
    const synth = window.speechSynthesis;
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    const apiKey = 'AIzaSyD3RO_JFzn5NYh_NXjueg_kBdJbBYa3rFs'; // Replace with your Google API key
    const cx = '26c215b77186a44bf'; // Replace with your Google Custom Search Engine CX
    const weatherApiKey = 'ccbee0f046cde04d99db1a20a3630353'; // Replace with your weather API key
    const iftttKey = 'YOUR_IFTTT_WEBHOOK_KEY'; // Replace with your IFTTT Webhook key
    const clientId = 'eeab699d6af448a4bb6304f02f929222'; // Replace with your Spotify Client ID
    const clientSecret = 'af75a37054614637a48ade34bb4de50e'; // Replace with your Spotify Client Secret
    const redirectUri = 'https://pheonix-personal-assistant.vercel.app/'; // Replace with your redirect URI

    let accessToken = ''; // Spotify access token

    recognition.start();

    recognition.onstart = () => {
      document.getElementById('output').innerText = "I'm listening...";
    };

    recognition.onresult = (event) => {
      const command = event.results[0][0].transcript.toLowerCase();
      document.getElementById('output').innerText = `You said: ${command}`;
      handleCommand(command);
    };

    recognition.onerror = (event) => {
      console.error("Recognition error: ", event.error);
      document.getElementById('output').innerText = "Sorry, I didn't catch that.";
    };

    recognition.onend = () => {
      recognition.start(); // Keeps listening
    };

    function respond(message) {
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.onend = () => recognition.start();
      synth.speak(utterance);
    }

    function handleCommand(command) {
      if (command.includes("hello phoenix")) {
        respond("Hello! How can I assist you today?");
      } else if (command.includes("search")) {
        const query = command.replace("search", "").replace("google", "").trim();
        searchGoogle(query);
      } else if (command.includes("weather in") || command.includes("weather at")) {
        const location = command.replace(/weather (in|at)/, "").trim();
        getWeather(location);
      } else if (command.includes("play")) {
        const song = command.replace("play", "").trim();
        playMusic(song);
      } else if (command.includes("turn on") || command.includes("turn off")) {
        controlDevice(command);
      } else if (command.includes("login to spotify")) {
        loginToSpotify();
      } else {
        respond("Sorry, I didn't understand that. Try saying 'search AI tools', 'play calm music', or 'weather in Lagos'");
      }
    }

    function searchGoogle(query) {
      const encodedQuery = encodeURIComponent(query);
      fetch(`https://www.googleapis.com/customsearch/v1?q=${encodedQuery}&key=${apiKey}&cx=${cx}`)
        .then(res => res.json())
        .then(data => {
          const items = data.items;
          if (items && items.length > 0) {
            const topResult = `${items[0].title} - ${items[0].link}`;
            document.getElementById('output').innerText = topResult;
            respond(`Here's what I found for ${query}`);
            window.open(items[0].link, '_blank');
          } else {
            document.getElementById('output').innerText = "No results found.";
            respond("No results found.");
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById('output').innerText = "Error fetching search results.";
          respond("I couldn't complete the search.");
        });
    }

    function getWeather(location) {
      const encoded = encodeURIComponent(location);
      fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encoded}&appid=${weatherApiKey}&units=metric`)
        .then(res => res.json())
        .then(data => {
          if (data.cod === 200) {
            const weather = data.weather[0].description;
            const temp = data.main.temp;
            const response = `Weather in ${location}: ${weather}, ${temp}Â°C`;
            document.getElementById('output').innerText = response;
            respond(response);
          } else {
            document.getElementById('output').innerText = `Couldn't find weather info for ${location}`;
            respond(`No weather info found for ${location}`);
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById('output').innerText = "Weather API error.";
          respond("Something went wrong getting weather info.");
        });
    }

    function playMusic(song) {
      if (!accessToken) {
        respond("Please log in to Spotify first by saying 'login to Spotify'");
        return;
      }

      const encoded = encodeURIComponent(song);
      const spotifyUrl = `https://api.spotify.com/v1/me/player/play`;
      const body = {
        uris: [`spotify:track:${encoded}`]
      };

      fetch(spotifyUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(body),
      })
      .then(response => response.json())
      .then(data => {
        respond(`Playing ${song} on Spotify.`);
      })
      .catch(err => {
        console.error('Error playing music on Spotify:', err);
        respond('Sorry, I couldn\'t play the music on Spotify.');
      });
    }

    function loginToSpotify() {
      const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${clientId}&scope=user-library-read user-read-private user-read-email streaming user-modify-playback-state&redirect_uri=${redirectUri}`;
      window.location.href = authUrl;
    }

    function getSpotifyToken(code) {
      const data = new URLSearchParams();
      data.append('grant_type', 'authorization_code');
      data.append('code', code);
      data.append('redirect_uri', redirectUri);
      data.append('client_id', clientId);
      data.append('client_secret', clientSecret);

      fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: data.toString(),
      })
      .then(response => response.json())
      .then(data => {
        accessToken = data.access_token;
        console.log('Spotify Access Token:', accessToken);
      })
      .catch(err => {
        console.error('Error fetching Spotify access token:', err);
      });
    }

    // Check if URL has authorization code after Spotify login redirect
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
      getSpotifyToken(code);
    }

    function controlDevice(command) {
      const action = command.includes("turn on") ? "on" : "off";
      const device = command.replace("turn on", "").replace("turn off", "").trim();
      const response = `Turning ${action} the ${device}`;
      document.getElementById('output').innerText = response;
      respond(response);

      // Make the IFTTT webhook request
      fetch(`https://maker.ifttt.com/trigger/your_event_name/with/key/${iftttKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ value1: device, value2: action })
      })
      .then(res => res.json())
      .then(data => console.log(data))
      .catch(err => console.error('Error controlling device:', err));
    }
  </script>
</body>
</html>